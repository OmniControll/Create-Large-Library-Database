//@version=5
indicator("Improved Bitcoin Risk Indicator", shorttitle="BTC Risk", overlay=false)

// User inputs
len1 = input.int(50, minval=1, title="Short-term SMA Length (Default: 50)")
len2 = input.int(350, minval=1, title="Long-term SMA Length (Default: 350)")
threshold = input.float(0.75, minval=0.01, maxval=1, step=0.01, title="Risk Threshold (Default: 0.75)")
showThreshold = input.bool(true, title="Show Risk Threshold Line")
atrLength = input.int(14, minval=1, title="ATR Length (Default: 14)")

// Daily Close
dailyClose = request.security(syminfo.tickerid, "D", close)

// SMA calculations
src1 = ta.sma(dailyClose, len1)
src2 = ta.sma(dailyClose, len2)
SMARatio = (src1 / src2)
SMARatioMaxVal = ta.highest(SMARatio, len1)

// ATR calculations
atr = ta.atr(atrLength)

// Bollinger Bands calculations
bbLength = input.int(20, minval=1, title="Bollinger Bands Length (Default: 20)")
bbMultiplier = input.float(2, minval=1, title="Bollinger Bands Multiplier (Default: 2)")
bbSMA = ta.sma(dailyClose, bbLength)
bbUpper = bbSMA + bbMultiplier * ta.stdev(dailyClose, bbLength)
bbLower = bbSMA - bbMultiplier * ta.stdev(dailyClose, bbLength)

// Normalizing indicators
normalizedSMARatio = SMARatio / SMARatioMaxVal
normalizedATR = atr / ta.highest(atr, atrLength)
normalizedBBWidth = (bbUpper - bbLower) / ta.highest(bbUpper - bbLower, bbLength)

// Composite risk score calculation
compositeRiskScore = (normalizedSMARatio + normalizedATR + normalizedBBWidth) / 3

// Scale the risk metric from 1 to 10
riskMetric = compositeRiskScore * 9 + 1

// Color coding for risk levels
lowRiskColor = color.new(color.green, 80)
mediumRiskColor = color.new(color.yellow, 80)
highRiskColor = color.new(color.red, 80)

lineColor = riskMetric < 5 ? lowRiskColor : riskMetric < threshold * 10 ? mediumRiskColor : highRiskColor

// Plot adjusted risk metric with color coding
plot(riskMetric, color=lineColor, linewidth=2, title="Risk Metric")

// Display the current risk level as a label
var label riskLabel = label.new(x=bar_index, y=riskMetric, style=label.style_label_down, color=color(na))
label.set_xy(riskLabel, bar_index, riskMetric)
label.set_text(riskLabel, "Risk: " + str.tostring(riskMetric, format.decimal2))
label.set_color(riskLabel, color = color.white)
label.set_style(riskLabel, riskMetric < 5 ? label.style_label_down : label.style_label_up)
